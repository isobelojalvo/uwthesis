\chapter{Event and Detector Simulation}
Event simulation is crucial 
to the success of the CMS experiment. 
The output of simulation should be similar if not the same as
the output of the detector; in this way the simulation and data can undergo the
same analytical processes.
Simulations are initiated using a program called 'event generator'.
The purpose of an event generator is to produce hypothetical
events with a distribution of observables as predicted by theory.
%simulated in geant4
%They can then be handed to a detector simulator such as Geantfour
%what is an event generator
%need more here
Event simulation can be used for the following:
\begin{itemize}
\item Aid in the design of detectors and experiments.
\item Provide a prediction 
of what physics processes can be expected and at what rates
\item As a tool for devising analysis strategies to optimize signal significance and
reduce unwanted backgrounds.
\item As a framework to in which to test signal significance.
\item As a means to test current physics theory/model and aid in the confirmation of new physics discovery.
\end{itemize}
In the study of particle physics it is important to not 
trust completely a single generator; if particle physics where perfectly
understood and well modeled then there would be no point in building a detector! 
Instead, it is important to understand the ingredients that go into 
a simulation and choose a generator which fits the desired observables. 
A number of physics generators
are in common use; a few of these are outline in section \ref{sec:MCGenerators}.
Physics simulation can be divided into a few key components:
The hard scattering matrix elements, which define the process(es) under study.
%The structure function
Final and initial state radiation
%\section{Physics Event Generation}
\section{Hard Scattering Process}
%Say something about simulation of hard processes
Hard scattering matrix element generation begins typically with a well defined subprocess.
%We wish to use an event generator which produces hypothetical events with a distribution
%that is predicted by theory.
%list issues
%It is easiest to address these issues 
Considering the simulation of 
the process $W\rightarrow\mu\nu$. 
\begin{equation}
d\sigma(\bar{q}q'\rightarrow W^{-}\rightarrow \mu^{-}\bar{\nu_{\mu}})
=f(x,\mu_{F})f'(x',\mu_{F})\frac{1}{2\hat{s}}|\mathcal{M}(\bar{q}q'\rightarrow W^{-}\rightarrow \mu^{-}\bar{\nu_{\mu}})|^{2}
\frac{d\cos\theta d\phi}{8(2\pi)^{2}}
\label{eq:matrixEle}
\end{equation}
%subject to the kinematic constraint that x1x2S=s where S 
%and s are the collider and subprocess centre of-mass energies-squared respectively
where the decay angles $(\theta,\phi)$ of the $W^{-}$ are two degrees of
freedom. $\mathcal{M}$ is the relevant matrix element, 
$q$ and $q'$ are the initial partons,
$1/(2\hat{s})$ is the parton flux and
 $\hat{s}=xx's$ where $s$ is the center of mass energy squared.
The factorization scale is $\mu_{F}$. 
%In typical event generators which simulate hard processes 
%ref equation
Equation (\ref{eq:matrixEle}) is used to write an event generator. 
To do this first a sampling of the relevant phase
space must be done using a random number generator and
momenta of the colliding constituents are selected by sampling
the parton distribution function of the proton at the energy scale
of the subprocess.

Next, the events must be unweighted using the hit-and-miss 
technique to produce events with observables. %%this is terrible
The relevant phase space for this process is two dimensional: -1 $< \cos\theta <$ 1,
0 $< \phi < $ 2$\pi$. The values of $cos\theta$ and $\phi$ can be chosen using
a uniform random number generator. 
Evaluating the equation (\ref{eq:matrixEle}) at $d\sigma(\theta_{i},\phi_{i})$ gives
that candidate event's differential cross section which is equivalent to the 
probability of this event occurring. The average of many candidate event's differential
cross section, $\langle d\sigma\rangle$, is an approximation to $\int d\sigma$ and converges
to the measured cross section.
So far, the candidate events are distributed flat in phase space and there is 
no physics information in the distributions.
The next step then is to unweight the event using the 'hit-and-miss' technique
so that they are distributed according to theoretical prediction. By unweighting
the events are generated with the frequency predicted by the theory 
being modeled and individual events represent what might be observed in a
trial experiment. 

%Parton Distribution Functions
%Parton Showering and Hadronization
\subsection{Parton Showering, Hadronization and the Underlying Event}
To successfully simulate an process in a hadron hadron collider the simulated event must undergo
parton showering, hadronization and simulation of the underlying event.
Parton showering is a form of correction to the hard scattering subprocess
where it is not feasible to calculate these processes exactly.
Programs that use the parton shower approach are also
able to simulate a wide variety of initial and final state processes.

\begin{figure}[hb]
  \centering
	\includegraphics[width=0.5\textwidth]{images/stringModel.png}
  	\caption[Lund String Model for Parton Showering]
   	{Lund String Model for Parton Showering}
	\label{fig:StringModel}
\end{figure}
The Lund String model for parton showering is based on models from lattice QCD simulations
which shows that at large distance the potential energy of color sources increases
linearly with their separation. 
A schematic showing parton showering using the Lund String model is 
shown in figure \ref{fig:StringModel}. 
Considering the production of a quark-anti-quark pair,
at first the quark and anti-quark are 
moving apart very quickly. A gluonic string is stretched between them,
its potential energy grows causing a reduction in the kinetic energy of the
quark-anti-quark system. When the gluon's potential energy reaches
the order of a hadron mass the gluon string breaks apart and a quark-anti-quark
pair is produced.

In a proton-proton interaction a parton is resolved
at scale $Q$ and momentum fraction $x$ from each
proton. Figure %%insert figure of event evolution
shows a proton-proton collision where a valence quark
is separated from one of the colliding protons and a 
a sea anti-quark is separated from the other of the colliding protons.
The phenomenology of the parton interaction is encoded
in the parton distribution function $f(x,Q^{2})$. 
The parton distribution function represents the probability
densities to find a parton carrying
a momentum faction $x$ at a squared energy
scale $Q^{2}$. 
Since the hadronization scale is much smaller than the hard scale the impact
of the hadronization model choice on the final state is typically
small for most physics analyses. 
Parton showers are essential in providing the %%exclusive?
description of the event: at leading order the transverse momentum
for the $W$ will always be zero since there is nothing for the $W$
to recoil against.

The beam remnants are the colored remains of the proton which
are left behind when the parton which participates in the hard subprocess
is pulled out. As the beam remnants are color connected to the hard
subprocess they should be included in the hadronization system. 
Multiple parton interactions (MPI) where more than one pair
of beam partons interact are also simulated. 
Due to the composite nature of hadrons and the low impact
parameter of spectator partons MPI
have an increase rate of occurrence in the presence of a 
hard scattering process. 
In the $\Wbb$ analysis
MPI agreement between data and simulation is tested 
by observing the ratio of $(p_{T,j_{1}}+p_{T,j_{2}})/p_{T,j_{1},j_{2}}$
Finally, pileup from other proton-proton collisions are added to the event.
%b quarks are not expected to be
%produced at any signiÞcant rate in nonperturbative processes [1], and they do not occur
%as valence ßavours of the commonly used beam particles. A priori, they are therefore
%excellent probes of the underlying hard dynamics, whether that involves standard QCD
%processes or various kinds of new physics
\section{Monte Carlo Generator Programs}

\label{sec:MCGenerators}
A number of monte carlo (MC) generators are used to simulate
physics processes. The MC method makes use of a random
number generator to simulate event to event fluctuations
which are %%%intrinsic
to quantum processes. 
The choice of MC generator is largely dependent on the 
type of process to be simulated. %fix
%K-factors
\subsection{MadGraph}
MadGraph is is a matrix element generator for SM processes at
any collider. It provides a computation of tree-level matrix elements
with a fixed number of partons in the final state. 
For a user-specified process MadGraph generates
the amplitudes for all relevant subprocesses and produces
the mappings for the integration over the phase space. 
The final state only 
Events may be passed directly to a shower MC program.
\subsection{Tauloa}
Tauloa is a package which is used for generation of tau lepton decays including
spin polarization. For each tau decay mode there is a individual phase space generator,
modeling of the weak decay including first order QED corrections for leptonic decays
and a part describing the hadronic current.
\subsection{PYTHIA}
At leading order \PYTHIA contains approximately 240 different $2\rightarrow n$ subprocesses.
The initial state shower is based on backwards evolution whereby the 
hard scattering process is simulated and is evolved backwards in time to the shower
initiators. Partons radiated in the initial state can initiate final-state showers
of their own. The Lund string model is used in hadronization; it is based on linear confinement
where quarks  are located at the ends of the string and gluons
are energy and momentum carrying kinds in the string. The production of a new $q\bar{q}$
pair causes the string to break. A quark from one break can combine with an antiquark
from an adjacent quark to form a meson. 
\subsection{MCFM}%reread carefully
Monte Carlo for FeMtobarn (MCFM) processes at hadron colliders is a parton-level Monte Carlo
program which gives NLO predictions for a range of processes at hadron colliders. MCFM
produces weighted events and therefore can
give very accurate predictions for event rates at NLO with cuts included, 
however it gives very little information about regions of phase space which are 
dominated by multiple parton interactions. 
Since the final state contains partons rather than hadrons, full detector simulation cannot
be performed using the MCFM output. Furthermore, a parton to hadron correction factor
must be included when comparing (for instance) with \PYTHIA, a generator which does
include hadrons in the final state.
%ref http://mcfm.fnal.gov/mcfm.pdf
\section{Detector Simulation}
\GEANTfour is a toolkit for simulating the passage of particles through matter.
In particular it provides tracking of particles taking account of the geometry, fields and physics processes.
Geometry simulation includes a detailed model of the experiment
including layout of the detectors and the location of absorbers (cables, cooling systems, ect.)
Run management for recording details of each run as well as
a number of options for the visualization of the simulation output.
\GEANTfour uses decay tables for particles such as $\pi$, $K$ mesons
and resonant baryons based on data from the Particle Data Group.
